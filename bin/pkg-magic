#!/bin/bash

#set -e

userbox(){
	kdialog --inputbox "Enter username:"
	local flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No username"
	fi
}

pwdbox(){
	kdialog --password "Enter password:"
	local flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No password"
	fi
}

catbox(){
	declare -A items
	items[any]=0
	items[daemons]=2
	items[devel]=3
	items[editors]=4
	items[emulators]=5
	items[games]=6
	items[gnome]=7
	items[i18n]=8
	items[kde]=9
	items[lib]=10
	items[modules]=11
	items[multimedia]=12
	items[network]=13
	items[office]=14
	items[science]=15
	items[system]=16
	items[x11]=17
	items[xfce]=18
	items[kernels]=19

	local select=$(kdialog --combobox "Select category"  "${!items[@]}") flag=$?
	if [ $flag -eq 1 ];then
		exit
	else
		if [[ ! -z $select ]];then
			echo "${items[$select]}"
		else
			echo ${items[any]}
		fi
	fi
}

popup(){
	kdialog --title "$1" --passivepopup "$2"  10
}

ynbox(){
	kdialog --warningcontinuecancel "${CONFIG} already exists. Overwrite?"
	local flag=$?
	if [ ${flag} -eq 0 ];then
		configdlg
	else
		exit
	fi
}

writer(){
	echo $1 >> "${CONFIG}"
}

new_config(){
	echo -n > ${CONFIG}
}

configdlg(){
	local user pwd
	user=$(userbox)
	pwd=$(pwdbox)
	if [[ -z ${user} ]] && [[ -z ${pwd} ]];then
		popup "Warning" "No config written."
		exit
	else
		new_config
		writer "USR=${user}"
		writer "PWD=${pwd}"
		popup "Success" "Config written."
	fi
}

pkgbox(){
	source ${URI}
	local i=0 items names switch=off
	if [[ ! -z ${pkgbase} ]];then
		for n in ${pkgname[*]};do
			items[$i]="$i $n $switch"
			names[$i]="$n"
			i=$((i+1))
		done
	fi
	local select=$(kdialog --checklist "Select packages:" ${items[@]}) flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No packages selected."
		exit
	else
		local list
		for s in ${select//\"/};do
			list="${list:-}${list:+,}${names[$s]}"
		done
		echo ${list}
	fi

}

rulesbox(){
	declare -A rules
	rules[0]=anyelf
	rules[1]=array
	rules[2]=badbackups
	rules[3]=capsnamespkg
	rules[4]=carch
	rules[5]=checksums
	rules[6]=directoryname
	rules[7]=elfexecstack
	rules[8]=elfpaths
	rules[9]=elftextrel
	rules[10]=emptydir
	rules[11]=extravars
	rules[12]=fhs-infopages
	rules[13]=fhs-manpages
	rules[14]=filenames
	rules[15]=fileownership
	rules[16]=giomodules
	rules[17]=glibschemas
	rules[18]=gnomemime
	rules[19]=hardlinks
	rules[20]=hicoloricons
	rules[21]=infodirectory
	rules[22]=infoinstall
	rules[23]=invalidstartdir
	rules[24]=javafiles
	rules[25]=kdeprograms
	rules[26]=libtool
	rules[27]=license
	rules[28]=licensepkg
	rules[29]=lots-of-docs
	rules[30]=mimedesktop
	rules[31]=mimefiles
	rules[32]=missingbackups
	rules[33]=perllocal
	rules[34]=permissions
	rules[35]=pkgnameindesc
	rules[36]=rpath
	rules[37]=rubypaths
	rules[38]=scrollkeeper
	rules[39]=sfurl
	rules[40]=shebangdepends
	rules[41]=sodepends
	rules[42]=splitpkgfunctions
	rules[43]=splitpkgmakedeps
	rules[44]=symlink
	rules[45]=tags
	rules[46]=urlpkg

 	local items switch=off
	for (( i=0; i<${#rules[@]}; ++i));do
		items[$i]="$i ${rules[$i]} ${switch}"
	done
 	local select=$(kdialog --checklist "Select rules:" ${items[@]}) flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No rules selected."
		return
	else
	 	local list
		for s in ${select//\"/};do
			list="${list:-}${list:+,}${rules[$s]}"
		done
		echo ${list}
	fi
}

optbox(){
	local q=$(kdialog --inputbox "Enter query:") flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No input."
		exit
	else
		echo $q
	fi
}

truncate(){
	local fn=$1
	echo ${fn%%-[0-9]*}
}

configure(){
   	if [[ ! -f "${CONFIG}" ]]; then
		configdlg
	else
		ynbox
	fi
}

get_session(){
	local user pwd  url="${URL}/login/" login session
	[[ -f "${CONFIG}" ]] &&  source ${CONFIG}
	if [[ ! -z ${USR} ]] && [[ ! -z ${PWD} ]];then
		user=${USR}
		pwd=${PWD}
	else
		user=$(userbox)
		pwd=$(pwdbox)
	fi
	login=$(curl -sSi -F user=${user} -F passwd=${pwd} -H 'Expect: ' ${url})
	session=$(echo "${login}" | awk '/^Set-Cookie: / {print $2}' | tr -d ';')
	echo ${session}
}

submit(){
	# $1: session
	local submit sid category url="${URL}/submit/"
	if [[ -z $1 ]];then
		popup "Canceled AUR upload." "No session registered."
		exit
	fi
	submit=$(curl -sSi -H 'Expect: ' -b $1 ${url})
	sid=$(echo "${submit}" | grep 'input.type..hidden..name..token..value' | cut -d\" -f6)

	submit=$(curl -sSi -H 'Expect: ' -F token="${sid}" -F pkgsubmit=1 -F category="$(catbox)" -F pfile=@${URI} -b $1 ${url} | tr -d '\r')

	echo "$(echo $submit)" > $wd/submit.log

	pkg_url="${URL}"$(echo "${submit}" | awk '/^Location: / {print $2}')
}

upload(){
	popup "AUR upload started." "$(basename ${URI})"
	submit "$(get_session)"
	local html='<a href="'"${pkg_url}"'">'"${pkg_url}"'</a>'
	popup "AUR upload finished." "${html}"
}

file_list(){
	local fn reqfn list
	for i in ${URI[*]};do
		fn=$(basename $i)
		if [[ ${PARAM} == "-Rr" ]];then
			reqfn=$(truncate $fn)
			list="${list:-}${list:+ }${reqfn}"
		else
			list="${list:-}${list:+ }${fn}"
		fi
	done
	echo ${list}
}

PARAM=$1
URI=$2
ARGS=$3
OPTS=$4
CONFIG="$HOME/.config/aurlogin"
URL="https://aur.archlinux.org"

get_workdir(){
	local wd
	for u in  ${URI[*]};do
		wd=$(dirname $u)
	done
	echo $wd
}

run_in_konsole(){
	# $1: cmd
	konsole --noclose --hide-menubar --workdir "$(get_workdir)" -e $SHELL -c "$1"
}

cmd_gen(){
	declare -A BIN
	BIN[-m]=makepkg
	BIN[-n]=namcap
	BIN[-Ra]=repo-add
	BIN[-Rr]=repo-remove
	BIN[-p]=pacman
	BIN[-t]=pactree
	BIN[-f]=pkgfile
	BIN[-y]=yaourt
	BIN[-c]=configure
	BIN[-a]=upload

	local CMD MISC EXT="tar.xz" IS_SU=0
	case ${PARAM} in
		"-Ra" | "-Rr")
			local REPO=$(basename $(get_workdir))
			MISC="${REPO}.${OPTS}.${EXT} $(file_list)"
		;;
		"-m")
			for p in ${ARGS[*]};do
				if [[ $p == "--pkg" ]];then
					MISC=$(pkgbox)
				fi
			done
		;;
		"-p")
			MISC=$(file_list)
			IS_SU=1
		;;
		"-t")
			MISC=$(truncate $(basename ${URI}))
		;;
		"-y")
			MISC=$(optbox)
		;;
		"-n")
			if [[ ${ARGS} == "-r" ]] || [[ ${ARGS} == "-e" ]];then
				MISC="$(rulesbox) ${URI}"
			else
				MISC=${URI}
			fi
		;;
		"-f")
			if [[ ${ARGS} == "-u" ]];then
				IS_SU=1
			else
				MISC=$(truncate $(basename ${URI}))
			fi
		;;
	esac
	if [ ${IS_SU} -eq 1 ];then
		CMD="sudo ${BIN[${PARAM}]} ${ARGS} ${MISC}"
	else
		CMD="${BIN[${PARAM}]} ${ARGS} ${MISC}"
	fi
	echo ${CMD}
}

if [[ ${PARAM} == "-a" ]] || [[ ${PARAM} == "-c" ]];then
	$(cmd_gen)
else
	#popup "CMD" "$(cmd_gen)"
	run_in_konsole "$(cmd_gen)"
fi
