#!/bin/bash

#set -e

param=$1
uri=$2
args=$3
action=$4
type=$5

config="$HOME/.config/aurlogin"
aur_url="https://aur.archlinux.org"
log="$HOME/debug.log"
ext="tar.xz"
categories=('daemons' 'devel' 'editors' 'emulators' 'games' 'gnome' 'i18n' 'kde' 'kernels' 'lib' 'modules' 'multimedia' 'network' 'office' 'science' 'system' 'x11' 'xfce')

userbox(){
	kdialog --inputbox "Enter username:"
	local flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No username"
	fi
}

pwdbox(){
	kdialog --password "Enter password:"
	local flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No password"
	fi
}

catbox(){
	kdialog --combobox "Select category"  "${categories[@]}"
	local flag=$?
	if [ $flag -eq 1 ];then
		popup "Chancel" "No category"
	fi
}

popup(){
	kdialog --title "$1" --passivepopup "$2"  10
}

ynbox(){
	kdialog --warningcontinuecancel "$config already exists. Overwrite?"
	local flag=$?
	if [ ${flag} -eq 0 ];then
		new_config
	else
		exit
	fi
}

writer(){
	echo $1 >> "$config"
}

debug(){
	popup "Debug" $1
}

new_config(){
	local user pwd ret=$?
	user=$(userbox)
	pwd=$(pwdbox)
	debug $user $pwd
	if [[ -z $user ]] && [[ -z $pwd ]];then
		popup "Warning" "No config written"
	else
		echo -n > "$config"
		writer "USR=$user"
		writer "PWD=$pwd"
	fi
}

configure(){
   	if [[ ! -f "$config" ]]; then
		new_config
	else
		ynbox
	fi
}

aur_login(){
	local user pwd page info target="${aur_url}/login/"

	[[ -f "$config" ]] &&  source $config

	if [[ ! -z $USR ]] && [[ ! -z $PWD ]];then
		user=$USR
		pwd=$PWD
	else
		user=$(userbox)
		pwd=$(pwdbox)
	fi
	page=$(curl -sSi -F user=$user -F passwd=$pwd -H 'Expect: ' $target)
	if [[ ! -z $session ]];then
		session=$(echo "$page" | awk '/^Set-Cookie: / {print $2}' | tr -d ';')
	else
		info=$(popup "Login failed." "Check your AUR user and pwd.")
	fi
}

aur_submit(){
	local page sid info cat=$(catbox) target="${aur_url}/submit/"

	if [[ -z $session ]];then
		info=$(popup "No session registered." "Aborted AUR upload.")
	fi

	page=$(curl -sSi -H 'Expect: ' -b $session $target)

	sid=$(echo "$page" | grep 'input.type..hidden..name..token..value' | cut -d\" -f6)

	page=$(curl -sSi -H 'Expect: ' -F token="$sid" -F pkgsubmit=1 -F category=$cat -F pfile=@$uri -b $session $target | tr -d '\r')

	local pkg_url html='<a href="'"${pkg_url}"'">'"${pkg_url}"'</a>'
	pkg_url="${aur_url}"$(echo "$page" | awk '/^Location: / {print $2}')
	info=$(popup "AUR upload finished." "${html}")
}

upload(){
	aur_login
	aur_submit
}

selected_files(){
	local fn reqfn list
	IFS=" "
	for i in ${uri};do
		fn=$(basename $i)
		if [ ${action} == "remove" ];then
			reqfn=${fn%%-[0-9]*}
			list+=" $reqfn"
		else
			list+=" $fn"
		fi
	done
	IFS=""
	echo ${list}
}

cmd_gen(){
	local bin cmd
	case ${param} in
		"-M")
			bin="makepkg"
			cmd="${bin} ${args}"
		;;
		"-N")
			bin="namcap"
			cmd="${bin} ${args} ${uri}"
		;;
		"-R")
			bin="repo"
			cmd="${bin}-${action} ${args} ${repo_name}.${type}.$ext $(selected_files)"
		;;
		"-P")
			bin="pacman"
			cmd="sudo ${bin} ${args} $(selected_files)"
		;;
	esac
	echo ${cmd}
}

run_in_konsole(){
	konsole --noclose --workdir "$wd" -e $SHELL -c "eval $(cmd_gen)"
}

main(){
	case ${param} in
		"-M" | "-N")
			wd=$(dirname $uri)
			run_in_konsole
		;;
		"-R" | "-P")
			IFS=" "
			for i in ${uri};do
				wd=$(dirname $i)
				repo_name=$(basename $wd)
			done
			IFS=""
			run_in_konsole
		;;
		"-U")
			upload
		;;
		"-C")
			configure
		;;
	esac
}

main

