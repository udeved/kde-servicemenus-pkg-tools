#!/bin/bash
#
#
#   pkg-magic - controlling script for kde-servicemenus-pkg-tools
#
#   Copyright (c) 2013-2014 artoo <flower_of_life@gmx.net>
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program.  If not, see <http://www.gnu.org/licenses/>.

shopt -s nullglob


actions='A:n:m:af:rf'
uri=

is_makepkg=false
is_repo_add=false
is_repo_remove=false
is_files=false
dbtype='db'
repo_param=''
is_namcap=false
is_aurball=false
cmd=''
rundir=$(pwd)

run(){
    konsole --noclose --hide-menubar --workdir "$rundir" -e $SHELL -c "$cmd"
}

add_pkgs(){
    local name=${rundir##*/}
    cmd="repo-add ${repo_param} ${rundir}/${name}.${dbtype}.tar.xz $OPTS"
}

rm_pkgs(){
    local name=${rundir##*/} selected=( $OPTS ) list=
    for u in ${selected[@]};do
	local temp=${u##*/}
	local pn=${temp%%-[0-9]*}
	list+=($pn)
    done
    cmd="repo-remove ${repo_param} ${rundir}/${name}.${dbtype}.tar.xz ${list[@]}"
}

while getopts "$actions" arg;do
    case ${arg} in
	m)
	    is_makepkg=true
	;;
	a)
	    is_repo_add=true
	;;
	r)
	    is_repo_remove=true
	;;
	f)
	    is_files=true
	    dbtype=files
	    repo_param='-f'
	;;
	n)
	    is_namcap=true
	    uri="${OPTARG}"
	;;
	A)
	    is_aurball=true
	;;
    esac
done

OPTS=("${*:$OPTIND}")

if ${is_makepkg}; then
    cmd="makepkg $OPTS"
elif ${is_aurball}; then
    cmd="mkaurball"
elif ${is_repo_add};then
    add_pkgs
elif ${is_repo_remove};then
    rm_pkgs
elif ${is_namcap}; then
    cmd="namcap $OPTS ${uri}"
fi

run
